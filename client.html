<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiDAR Robot Simulator - 4è¼ªã‚ªãƒ ãƒ‹ãƒ›ã‚¤ãƒ¼ãƒ«å¯¾å¿œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; background-color: #1a1a1a; cursor: crosshair; }
        #ui-layer { position: absolute; top: 10px; left: 10px; pointer-events: none; max-height: calc(100vh - 20px); overflow-y: auto; }
        .panel { background: rgba(0, 0, 0, 0.9); padding: 15px; border-radius: 8px; pointer-events: auto; margin-bottom: 10px; border: 1px solid #444; max-width: 350px; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .panel.collapsed .panel-content { display: none; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .panel-header:hover { opacity: 0.8; }
        .collapse-btn { font-size: 1.2rem; transition: transform 0.3s; }
        .panel.collapsed .collapse-btn { transform: rotate(-90deg); }
        .panel-content { margin-top: 10px; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; align-items: center; }
        .stat-label { color: #aaa; font-size: 0.85rem; }
        .stat-value { font-family: 'Courier New', monospace; color: #fff; font-weight: bold; }
        button {
            background: #2563eb; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 5px; font-weight: bold; transition: background 0.2s;
            font-size: 0.9rem;
        }
        button:hover { background: #1d4ed8; }
        button.secondary { background: #4b5563; margin-top: 5px; }
        button.secondary:hover { background: #374151; }
        button.active { background: #eab308; color: black; }
        button.active:hover { background: #ca8a04; }
        h1 { margin: 0 0 10px 0; font-size: 1.1rem; border-bottom: 1px solid #555; padding-bottom: 5px; color: #fff; }
        .legend-item { display: flex; align-items: center; margin-bottom: 4px; font-size: 0.8rem; }
        .dot { width: 12px; height: 12px; border-radius: 2px; margin-right: 8px; display: inline-block;}
        .specs-tag { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; color: #00ff00; margin-left: 5px; }
        .connection-status { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.9); padding: 8px 12px; border-radius: 4px; font-size: 0.8rem; border: 1px solid #444; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background: #22c55e; }
        .disconnected { background: #ef4444; }
        .command-display { background: #1a1a2e; padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85rem; margin-top: 10px; }
        .command-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .command-label { color: #888; }
        .command-value { color: #00ff00; }
        .lidar-offset { background: #2a2a4e; padding: 8px; border-radius: 4px; margin-top: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <canvas id="simCanvas"></canvas>

    <div class="connection-status">
        <span class="status-dot disconnected" id="status-dot"></span>
        <span id="connection-text">æ¥ç¶šä¸­...</span>
    </div>

    <div id="ui-layer">
        <div class="panel" id="main-panel">
            <div class="panel-header" onclick="togglePanel('main-panel')">
                <h1 style="margin: 0;">4è¼ªã‚ªãƒ ãƒ‹ LiDAR Sim <span class="specs-tag">A* + AMCL</span></h1>
                <span class="collapse-btn">â–¼</span>
            </div>
            
            <div class="panel-content">
            <div class="stat-row">
                <span class="stat-label">Status</span>
                <span class="stat-value" id="status-text" style="color:#00ff00;">IDLE</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">AMCL Error</span>
                <span class="stat-value" id="pos-error">0.00 m</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Path Length</span>
                <span class="stat-value" id="path-len">0 nodes</span>
            </div>
            
            <!-- ãƒã‚¤ã‚³ãƒ³æŒ‡ä»¤å€¤è¡¨ç¤º -->
            <div class="command-display">
                <div style="color: #eab308; margin-bottom: 5px; font-weight: bold;">ğŸ“¡ ãƒã‚¤ã‚³ãƒ³æŒ‡ä»¤å€¤ (m/s, rad/s)</div>
                <div class="command-row">
                    <span class="command-label">vx (å‰æ–¹):</span>
                    <span class="command-value" id="cmd-vx">0.000</span>
                </div>
                <div class="command-row">
                    <span class="command-label">vy (å·¦æ–¹):</span>
                    <span class="command-value" id="cmd-vy">0.000</span>
                </div>
                <div class="command-row">
                    <span class="command-label">Ï‰ (å›è»¢):</span>
                    <span class="command-value" id="cmd-omega">0.000</span>
                </div>
            </div>
            
            <div style="margin-top: 15px; font-size: 0.8rem; border-top: 1px solid #444; padding-top: 10px;">
                <div class="legend-item"><div class="dot" style="background:#22c55e; border-radius:50%;"></div>Robot (Green)</div>
                <div class="legend-item"><div class="dot" style="background:#00ffff; border-radius:50%;"></div>Estimate (Cyan)</div>
                <div class="legend-item"><div class="dot" style="background:#ff3300; border-radius:50%;"></div>LiDAR Points</div>
                <div class="legend-item"><div class="dot" style="background:#00ff00;"></div>Planned Path</div>
                <div class="legend-item"><div class="dot" style="background:rgba(255, 0, 0, 0.5);"></div>Particles</div>
            </div>

            <button id="btn-init-pose" onclick="toggleInitPoseMode()">ğŸ“ 2D Pose Estimate</button>
            <button onclick="globalLocalization()" style="background: #059669;">ğŸ” Global Localization</button>
            <button onclick="resetSimulation()">Reset Simulation</button>
            <button class="secondary" onclick="kidnapRobot()">Kidnap (Random Position)</button>
            <button class="secondary" onclick="document.getElementById('mapUpload').click()">ğŸ“ Load Map Image</button>
            <input type="file" id="mapUpload" accept="image/*" style="display:none" onchange="handleMapUpload(event)">
            </div>
        </div>
        
        <!-- ãƒ­ãƒœãƒƒãƒˆè¨­å®šãƒ‘ãƒãƒ« -->
        <div class="panel collapsed" id="config-panel">
            <div class="panel-header" onclick="togglePanel('config-panel')">
                <h1 style="margin: 0; font-size: 1rem;">ğŸ”§ ãƒ­ãƒœãƒƒãƒˆè¨­å®š</h1>
                <span class="collapse-btn">â–¼</span>
            </div>
            <div class="panel-content" style="font-size: 0.8rem;">
                <div class="lidar-offset">
                    <div style="color: #eab308; margin-bottom: 5px;">LiDARä½ç½®ã‚ªãƒ•ã‚»ãƒƒãƒˆ</div>
                    <div>X: <span id="lidar-offset-x">0.10</span> m (å‰æ–¹)</div>
                    <div>Y: <span id="lidar-offset-y">0.00</span> m (å·¦æ–¹)</div>
                </div>
                <div style="margin-top: 10px; color: #888;">
                    <p>â€» è¨­å®šã¯ robot-config.json ã§ç·¨é›†</p>
                    <p>4è¼ªã‚ªãƒ ãƒ‹ãƒ›ã‚¤ãƒ¼ãƒ«å¯¾å¿œ</p>
                    <p>LiDAR: å·¦å‰è¼ª-å³å¾Œè¼ªå»¶é•·ç·šä¸Š</p>
                </div>
            </div>
        </div>
        
        <div class="panel collapsed" id="help-panel">
            <div class="panel-header" onclick="togglePanel('help-panel')">
                <h1 style="margin: 0; font-size: 1rem;">â“ ãƒ˜ãƒ«ãƒ—</h1>
                <span class="collapse-btn">â–¼</span>
            </div>
            <div class="panel-content" style="font-size: 0.8rem; color: #aaa;">
                <p><strong>ã‚¯ãƒªãƒƒã‚¯:</strong> ç›®æ¨™åœ°ç‚¹è¨­å®š</p>
                <p><strong>2D Pose Estimate:</strong> ãƒ‰ãƒ©ãƒƒã‚°ã§åˆæœŸä½ç½®ã¨å‘ãã‚’è¨­å®š</p>
                <p><strong>Global Localization:</strong> ä½ç½®ä¸æ˜æ™‚ã«ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’å…¨ä½“ã«æ•£å¸ƒ</p>
                <p><strong>Kidnap:</strong> ãƒ­ãƒœãƒƒãƒˆã‚’ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ã«ç§»å‹•ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰</p>
            </div>
        </div>
    </div>

<script>
const METERS_TO_PIXELS = 40; 
const GRID_RES = 0.10; 
const PIXELS_PER_GRID = GRID_RES * METERS_TO_PIXELS;

// WebSocketæ¥ç¶š
const socket = io();

// Canvas setup
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// State
let gameState = null;
let interactionMode = 'GOAL'; // 'GOAL' or 'INIT_POSE'
let dragStart = null, dragEnd = null;

// Connection status
socket.on('connect', () => {
    console.log('Connected to server');
    document.getElementById('status-dot').className = 'status-dot connected';
    document.getElementById('connection-text').textContent = 'æ¥ç¶šæ¸ˆã¿';
    
    // ãƒ­ãƒœãƒƒãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
    loadRobotConfig();
});

socket.on('disconnect', () => {
    console.log('Disconnected from server');
    document.getElementById('status-dot').className = 'status-dot disconnected';
    document.getElementById('connection-text').textContent = 'åˆ‡æ–­';
});

// ãƒ­ãƒœãƒƒãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
async function loadRobotConfig() {
    try {
        const response = await fetch('/api/config');
        if (response.ok) {
            const config = await response.json();
            if (config.lidar) {
                document.getElementById('lidar-offset-x').textContent = (config.lidar.offsetX_M || 0).toFixed(2);
                document.getElementById('lidar-offset-y').textContent = (config.lidar.offsetY_M || 0).toFixed(2);
            }
        }
    } catch (error) {
        console.error('Failed to load robot config:', error);
    }
}

// åˆæœŸåŒ–
socket.on('init', (state) => {
    console.log('Received initial state', state);
    gameState = state;
    
    // åˆæœŸä½ç½®æƒ…å ±ã‚’è¡¨ç¤º
    if (state.initialPose) {
        const ip = state.initialPose;
        console.log(`ğŸ¤– Initial pose: x=${ip.x_m.toFixed(2)}m, y=${ip.y_m.toFixed(2)}m, Î¸=${ip.theta_deg.toFixed(1)}Â°`);
        
        // åˆæœŸä½ç½®é€šçŸ¥ã‚’è¡¨ç¤º
        showInitialPoseNotification(ip);
    }
    
    draw();
    updateUI();
});

/**
 * åˆæœŸä½ç½®é€šçŸ¥ã‚’ç”»é¢ã«è¡¨ç¤º
 */
function showInitialPoseNotification(pose) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 60px;
        right: 10px;
        background: rgba(34, 197, 94, 0.95);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        font-family: 'Segoe UI', sans-serif;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 8px;">ğŸ¤– åˆæœŸä½ç½®ãŒè‡ªå‹•è¨­å®šã•ã‚Œã¾ã—ãŸ</div>
        <div style="font-family: 'Courier New', monospace;">
            <div>X: ${pose.x_m.toFixed(2)} m</div>
            <div>Y: ${pose.y_m.toFixed(2)} m</div>
            <div>Î¸: ${pose.theta_deg.toFixed(1)}Â°</div>
        </div>
        <div style="margin-top: 10px; font-size: 12px; opacity: 0.9;">
            â€» 2D Pose Estimateã§å†è¨­å®šå¯èƒ½
        </div>
    `;
    document.body.appendChild(notification);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³CSSè¿½åŠ 
    if (!document.getElementById('notification-style')) {
        const style = document.createElement('style');
        style.id = 'notification-style';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    // 5ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã—ã¦å‰Šé™¤
    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s ease-out forwards';
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}

// çŠ¶æ…‹æ›´æ–°
socket.on('state', (state) => {
    gameState = state;
    updateUI();
});

// Goalè¨­å®šçµæœ
socket.on('goalResult', (result) => {
    if (result.success) {
        console.log('Path found:', result.pathLength, 'points');
    } else {
        console.log('Path planning failed:', result.message);
        alert('çµŒè·¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }
});

// ãƒãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ
socket.on('mapLoadResult', (result) => {
    if (result.success) {
        console.log('Map loaded successfully');
    } else {
        console.log('Map loading failed:', result.message);
        alert('ãƒãƒƒãƒ—ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
    }
});

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³çµæœ
socket.on('globalLocalizationResult', (result) => {
    if (result.success) {
        console.log('Global localization complete. Error:', result.error.toFixed(3), 'm');
    } else {
        console.log('Global localization failed');
    }
});

// æç”»é–¢æ•°
function draw() {
    if (!gameState) return;
    
    // 1. Background
    ctx.fillStyle = '#121212';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // 2. Grid
    ctx.strokeStyle = '#222';
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let x = 0; x < canvas.width; x += METERS_TO_PIXELS) {
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
    }
    for(let y = 0; y < canvas.height; y += METERS_TO_PIXELS) {
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
    }
    ctx.stroke();
    
    // 3. Walls
    ctx.strokeStyle = '#888';
    ctx.lineWidth = 3;
    ctx.beginPath();
    for(let w of gameState.walls) {
        ctx.moveTo(w.p1.x, w.p1.y);
        ctx.lineTo(w.p2.x, w.p2.y);
    }
    ctx.stroke();
    
    // 4. Path
    if (gameState.path && gameState.path.length > 0) {
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(gameState.path[0].x, gameState.path[0].y);
        for (let p of gameState.path) {
            ctx.lineTo(p.x, p.y);
        }
        ctx.stroke();
        
        // ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã®ãƒãƒ¼ã‚«ãƒ¼
        const goal = gameState.path[gameState.path.length - 1];
        ctx.fillStyle = '#ff0000';
        ctx.beginPath();
        ctx.arc(goal.x, goal.y, 8, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // 5. Particles
    ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
    for(let p of gameState.particles) {
        ctx.fillRect(p.x - 1, p.y - 1, 2, 2);
    }
    
    // 6. Robot (True position)
    const pos = gameState.robot.pose;
    ctx.save();
    ctx.translate(pos.x, pos.y);
    ctx.rotate(pos.theta);
    
    // ãƒ­ãƒœãƒƒãƒˆæœ¬ä½“
    ctx.fillStyle = '#22c55e';
    ctx.beginPath();
    ctx.arc(0, 0, gameState.robot.radius, 0, Math.PI * 2);
    ctx.fill();
    
    // æ–¹å‘ãƒãƒ¼ã‚«ãƒ¼
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(gameState.robot.radius, 0);
    ctx.stroke();
    
    // LiDARä½ç½®è¡¨ç¤ºï¼ˆå°ã•ãªç‚¹ï¼‰
    ctx.fillStyle = '#ff0000';
    ctx.beginPath();
    ctx.arc(4, 0, 3, 0, Math.PI * 2); // offsetX_M * METERS_TO_PIXELS â‰ˆ 4
    ctx.fill();
    
    ctx.restore();
    
    // 7. Estimate
    const est = gameState.estimate;
    ctx.save();
    ctx.translate(est.x, est.y);
    ctx.rotate(est.theta);
    ctx.strokeStyle = 'cyan';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(0, 0, gameState.robot.radius + 5, 0, Math.PI * 2);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(gameState.robot.radius + 8, 0);
    ctx.stroke();
    ctx.restore();
    
    // 8. LiDAR scan (from TRUE robot position - not estimate)
    // æ³¨æ„: ã‚¹ã‚­ãƒ£ãƒ³ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒœãƒƒãƒˆã®çœŸã®ä½ç½®ã‹ã‚‰å–å¾—ã•ã‚ŒãŸã‚‚ã®
    const scan = gameState.scan;
    const truePos = gameState.robot.pose;
    const startAng = truePos.theta;
    const angStep = (Math.PI * 2) / scan.length;
    ctx.fillStyle = '#ff3300';
    for(let i = 0; i < scan.length; i++) {
        const dist = scan[i];
        const maxRange = 12.0 * METERS_TO_PIXELS;
        if(dist > maxRange * 0.95) continue;
        const a = startAng + i * angStep;
        const px = truePos.x + Math.cos(a) * dist;
        const py = truePos.y + Math.sin(a) * dist;
        ctx.fillRect(px - 1, py - 1, 2, 2);
    }
    
    // 9. Drag for init pose
    if(interactionMode === 'INIT_POSE' && dragStart && dragEnd) {
        ctx.strokeStyle = '#eab308';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(dragStart.x, dragStart.y);
        ctx.lineTo(dragEnd.x, dragEnd.y);
        ctx.stroke();
        
        // çŸ¢å°ã®å…ˆç«¯
        const angle = Math.atan2(dragEnd.y - dragStart.y, dragEnd.x - dragStart.x);
        const arrowLen = 15;
        ctx.beginPath();
        ctx.moveTo(dragEnd.x, dragEnd.y);
        ctx.lineTo(dragEnd.x - arrowLen * Math.cos(angle - 0.4), dragEnd.y - arrowLen * Math.sin(angle - 0.4));
        ctx.moveTo(dragEnd.x, dragEnd.y);
        ctx.lineTo(dragEnd.x - arrowLen * Math.cos(angle + 0.4), dragEnd.y - arrowLen * Math.sin(angle + 0.4));
        ctx.stroke();
    }
}

function updateUI() {
    if (!gameState) return;
    
    document.getElementById('pos-error').innerText = gameState.stats.posError.toFixed(3) + " m";
    document.getElementById('path-len').innerText = gameState.stats.pathLength > 0 ? gameState.stats.pathLength + " pts" : "None";
    
    // ãƒã‚¤ã‚³ãƒ³æŒ‡ä»¤å€¤ã‚’æ›´æ–°
    if (gameState.command) {
        document.getElementById('cmd-vx').innerText = gameState.command.vx.toFixed(3);
        document.getElementById('cmd-vy').innerText = gameState.command.vy.toFixed(3);
        document.getElementById('cmd-omega').innerText = gameState.command.omega.toFixed(3);
    }
    
    let st = interactionMode === 'INIT_POSE' ? "SET POSE" : gameState.stats.status;
    document.getElementById('status-text').innerText = st;
}

function toggleInitPoseMode() {
    const btn = document.getElementById('btn-init-pose');
    interactionMode = (interactionMode === 'INIT_POSE') ? 'GOAL' : 'INIT_POSE';
    if (interactionMode === 'INIT_POSE') {
        btn.classList.add('active');
    } else {
        btn.classList.remove('active');
    }
}

function resetSimulation() {
    socket.emit('reset', { width: canvas.width, height: canvas.height });
}

function kidnapRobot() {
    socket.emit('kidnap');
}

function globalLocalization() {
    console.log('Performing global localization...');
    socket.emit('globalLocalization');
}

// ãƒ‘ãƒãƒ«ã®æŠ˜ã‚ŠãŸãŸã¿
function togglePanel(panelId) {
    const panel = document.getElementById(panelId);
    if (panel) {
        panel.classList.toggle('collapsed');
    }
}

// ç”»åƒã‹ã‚‰ãƒãƒƒãƒ—ã‚’èª­ã¿è¾¼ã‚€
async function handleMapUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('Uploading map image...');
    
    const formData = new FormData();
    formData.append('mapImage', file);
    
    try {
        const response = await fetch('/upload-map', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log('Image processed, loading into simulation...');
            socket.emit('loadMapImage', result.imageData);
        } else {
            alert('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message);
        }
    } catch (error) {
        console.error('Upload error:', error);
        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + error.message);
    }
    
    // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
    event.target.value = '';
}

// Math utility
function normalizeAngle(angle) {
    while (angle > Math.PI) angle -= 2 * Math.PI;
    while (angle < -Math.PI) angle += 2 * Math.PI;
    return angle;
}

function dist(p1, p2) {
    return Math.hypot(p2.x - p1.x, p2.y - p1.y);
}

// Mouse events
canvas.addEventListener('mousedown', e => {
    const r = canvas.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    
    if(interactionMode === 'GOAL') {
        // Send goal to server
        socket.emit('setGoal', { x, y });
    } else {
        // Start drag for init pose
        dragStart = { x, y };
        dragEnd = { x, y };
    }
});

canvas.addEventListener('mousemove', e => {
    if(interactionMode === 'INIT_POSE' && dragStart) {
        const r = canvas.getBoundingClientRect();
        dragEnd = { x: e.clientX - r.left, y: e.clientY - r.top };
        draw(); // Redraw to show drag line
    }
});

canvas.addEventListener('mouseup', e => {
    if(interactionMode === 'INIT_POSE' && dragStart) {
        const r = canvas.getBoundingClientRect();
        const ex = e.clientX - r.left;
        const ey = e.clientY - r.top;
        
        let theta = (dist(dragStart, {x: ex, y: ey}) < 10) ? 0 : Math.atan2(ey - dragStart.y, ex - dragStart.x);
        
        // Send init pose to server
        socket.emit('setInitPose', { 
            x: dragStart.x, 
            y: dragStart.y, 
            theta: theta 
        });
        
        dragStart = null;
        dragEnd = null;
        toggleInitPoseMode();
    }
});

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    resetSimulation();
});

// Animation loop for smooth rendering
function animate() {
    if (gameState) {
        draw();
    }
    requestAnimationFrame(animate);
}

animate();
</script>
</body>
</html>
